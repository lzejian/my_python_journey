name: æ¯æ—¥åŸºé‡‘ç­–ç•¥ (æ•°æ®åˆ†ç¦»ç‰ˆ)

on:
  schedule:
    - cron: '10 6 * * 1-5' # åŒ—äº¬æ—¶é—´ 14:10
  workflow_dispatch:

jobs:
  run_strategies:
    runs-on: ubuntu-latest
    
    steps:
    # --- ç¬¬ä¸€é˜¶æ®µï¼šå‡†å¤‡ç¯å¢ƒ ---
    - name: 1. æ‹‰å–ä»£ç  (Masteråˆ†æ”¯)
      uses: actions/checkout@v3
      
    # ã€æ–°å¢æ­¥éª¤ã€‘ä»æ•°æ®åˆ†æ”¯â€œä¸‹è½½â€è®°å¿†æ–‡ä»¶
    - name: ğŸ“¥ ä¸‹è½½å†å²è®°å¿† (ä» data-storage åˆ†æ”¯)
      run: |
        # å°è¯•ä» data-storage åˆ†æ”¯æ£€å‡ºæ‰€æœ‰çš„ json æ–‡ä»¶åˆ°å½“å‰ç›®å½•
        # å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œï¼ˆæ²¡æœ‰jsonï¼‰ï¼Œå…è®¸æŠ¥é”™ç»§ç»­
        git fetch origin data-storage
        git checkout origin/data-storage -- *.json || echo "âš ï¸ æš‚æ— å†å²æ•°æ®ï¼Œå°†åˆå§‹åŒ–æ–°æ•°æ®"

    - name: 2. è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: 3. å®‰è£…ä¾èµ–åº“
      run: pip install akshare requests pandas

    # --- ç¬¬äºŒé˜¶æ®µï¼šå¤§è„‘è¿ç®— ---
    - name: 4. è¿è¡Œçº³æŒ‡ç­–ç•¥
      continue-on-error: true 
      run: python smart_strategy.py
      
    - name: â¸ï¸ ç­‰å¾…æ¶ˆæ¯æ¨é€
      run: sleep 15

    - name: 5. è¿è¡Œé»„é‡‘ç­–ç•¥
      continue-on-error: true
      run: python gold_strategy.py

    # --- ç¬¬ä¸‰é˜¶æ®µï¼šä¿å­˜è®°å¿†åˆ°ç‹¬ç«‹åˆ†æ”¯ ---
    - name: 6. ã€æ ¸å¿ƒã€‘ä¿å­˜è®°å¿† (æ¨é€åˆ° data-storage)
      run: |
        # é…ç½® Git ç”¨æˆ·
        git config --global user.name "GitHub Action Bot"
        git config --global user.email "actions@github.com"
        
        # 1. æŠŠç”Ÿæˆçš„ json æ–‡ä»¶ç§»åŠ¨åˆ°ä¸´æ—¶æ–‡ä»¶å¤¹ /tmp
        # ä¸ºä»€ä¹ˆè¦ç§»èµ°ï¼Ÿå› ä¸ºæˆ‘ä»¬è¦åˆ‡æ¢åˆ†æ”¯ï¼Œå¦‚æœä¸ç§»èµ°å¯èƒ½ä¼šè¢«è¦†ç›–æˆ–å†²çª
        cp *.json /tmp/ || echo "æ²¡æœ‰ç”Ÿæˆ JSON æ–‡ä»¶"
        
        # 2. åˆ‡æ¢åˆ°æ•°æ®åˆ†æ”¯ (data-storage)
        # -f å¼ºåˆ¶åˆ‡æ¢ï¼Œä¸ç†ä¼šå½“å‰å·¥ä½œåŒºçš„ä»£ç æ–‡ä»¶
        git fetch origin data-storage
        git checkout -f data-storage
        
        # 3. æŠŠ json æ–‡ä»¶ä»ä¸´æ—¶æ–‡ä»¶å¤¹æ‹¿å›æ¥
        cp /tmp/*.json .
        
        # 4. æäº¤å¹¶æ¨é€
        git add *.json
        
        if git diff --staged --quiet; then
          echo "ğŸ“… æ•°æ®æ— å˜åŒ–ï¼Œæ— éœ€ä¿å­˜"
        else
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°è®°å¿† [$(date +'%Y-%m-%d')]"
          git push origin data-storage
          echo "âœ… è®°å¿†æ•°æ®å·²ä¿å­˜åˆ° data-storage åˆ†æ”¯"
        fi